<link rel="stylesheet/less" type="text/css" href="pills.less" />
<script src="less.js?theseus=no" type="text/javascript"></script>
<script src="fondue.browser.js?theseus=no" type="text/javascript"></script>
<script>
fondue = require("fondue");
</script>

<style>
.CodeMirror {
	border: 1px solid black;
}
</style>

<script type="text/javascript" src="jquery.js?theseus=no"></script>

<script src="codemirror-3.13/lib/codemirror.js?theseus=no"></script>
<link rel="stylesheet" href="codemirror-3.13/lib/codemirror.css">
<script src="codemirror-3.13/mode/javascript/javascript.js?theseus=no"></script>

<script>
/**
shape: "circle" or "square"
color: CSS color string like "#1f77b4"
**/
function Glyph(shape, color) {
	this._shape = shape;
	this._color = color;
}
Glyph.prototype = {
	svg: function () {
		if (this._shape === "circle") {
			return '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" class="glyph"><circle cx="5" cy="5" r="5" fill="' + this._color + '" /></svg>';
		} else if (this._shape === "square") {
			return '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" class="glyph"><rect x="1" y="1" width="8" height="8" fill="' + this._color + '" /></svg>';
		}
	},
};

function Cycle(values) {
	this._values = values;
	this._next = 0;
}
Cycle.prototype = {
	next: function () {
		var value = this._values[this._next];
		this._next = (this._next + 1) % this._values.length;
		return value;
	}
};

var _colorCycle = new Cycle("#1f77b4 #ff7f0e #2ca02c #d62728 #9467bd #8c564b #e377c2 #7f7f7f #bcbd22 #17becf #000000".split(" "));
var _shapeCycle = new Cycle(["circle", "square"]);
var _glyphCycle = {
	next: function () {
		return new Glyph(_shapeCycle.next(), _colorCycle.next());
	},
};

/**
line: number or handle
Listen for clicks with pillView.on("click", function () {})
**/
function PillView(codeMirror, line) {
	this.codeMirror = codeMirror;
	this.$dom = $('<span class="theseus-call-count none"><span class="counts">0 calls</span></span>');
	this.$dom.append(_glyphCycle.next().svg());
	codeMirror.setGutterMarker(line, 'pill-gutter', this.$dom[0]);
	this.on = this.$dom.on.bind(this.$dom);
}
PillView.prototype = {
	setCount: function (count) {
		var html = count + ' call' + (count === 1 ? '' : 's');
		this.$dom.find('.counts').html(html);
		this.$dom.toggleClass("none", count === 0);
	},
	setHasExceptions: function (hasExceptions) {
		this.hasExceptions = hasExceptions;
		this.$dom.toggleClass("exception", hasExceptions);
	},
	setActive: function (isActive) {
		this.isActive = isActive;
		this.$dom.toggleClass('active', isActive);
	},
};

 function LogHandle(tracer_, query) {
	 var handle = tracer_.trackLogs(query);
	 
	 return {
		 fetch: function () {
			 return tracer_.logDelta(handle, 10);
		 },
		 count: function () {
			 return tracer_.logCount(handle);
		 },
	 };
 }

$(function () {
	var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
		lineNumbers: true,
		 gutters: ['pill-gutter'],
	});
	
	var src = editor.getValue();
	var path = "script1";
	var instrumentedSrc = fondue.instrument(src, {
		tracer_name: "fiddleTracer",
		path: path,
	});
	eval(instrumentedSrc);
	
	var query = { ids: [], eventNames: [], exceptions: false, logs: false };
	var logHandle = new LogHandle(fiddleTracer, query); // !!!
	
	var countConsoleLogsHandle = new LogHandle(fiddleTracer, { ids: [], logs: true });
	var countExceptionsHandle = new LogHandle(fiddleTracer, { ids: [], exceptions: true });
	
	function queryChanged() {
		logHandle = fiddleTracer.trackLogs(query);
	}
	
	var nodesById = {};
	var pillsByNodeId = {};
	var nodesHandle = fiddleTracer.trackNodes();
	fiddleTracer.newNodes(nodesHandle).filter(function (node) {
		return node.path === path;
	}).forEach(function (node) {
		nodesById[node.id] = node;
		if (node.type === "function") {
			var pill = pillsByNodeId[node.id] = new PillView(editor, node.start.line - 1);
			pill.on("click", function () {
				pill.setActive(!pill.isActive);
			});
		}
	});
	
	var hitsHandle = fiddleTracer.trackHits();
	var totalHitsByNodeId = {};
	setInterval(function () {
		var delta = fiddleTracer.hitCountDeltas(hitsHandle);
		for (var nodeId in delta) {
			var pill = pillsByNodeId[nodeId];
			if (delta.hasOwnProperty(nodeId) && pill) {
				totalHitsByNodeId[nodeId] || (totalHitsByNodeId[nodeId] = 0);
				totalHitsByNodeId[nodeId] += delta[nodeId];
				pill.setCount(totalHitsByNodeId[nodeId]);
			}
		}
	}, 100);
});
</script>

<textarea id="code">
$(document.body).on('mousemove', function () {
});

$(document.body).on('click', function () {
});

$(document.body).on('keypress', function () {
});

setInterval(function () {
	if (Math.random() &lt; 0.1) {
	} else {
	}
}, 2000);
</textarea>
