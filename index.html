<link rel="stylesheet/less" type="text/css" href="pills.less" />
<script src="less.js?theseus=no" type="text/javascript"></script>
<script src="fondue.browser.js?theseus=no" type="text/javascript"></script>
<script>
fondue = require("fondue");
</script>

<style>
.CodeMirror {
	border: 1px solid black;
}
</style>

<script type="text/javascript" src="jquery.js?theseus=no"></script>

<script src="codemirror-3.13/lib/codemirror.js?theseus=no"></script>
<link rel="stylesheet" href="codemirror-3.13/lib/codemirror.css">
<script src="codemirror-3.13/mode/javascript/javascript.js?theseus=no"></script>

<script>
/** line: number or handle **/
function PillView(codeMirror, line) {
	this.codeMirror = codeMirror;
	this.$dom = $('<span class="theseus-call-count none"><span class="counts">0 calls</span></span>');
	codeMirror.setGutterMarker(line, 'pill-gutter', this.$dom[0]);
}
PillView.prototype = {
	setCount: function (count) {
		var html = count + ' call' + (count === 1 ? '' : 's');
		this.$dom.find('.counts').html(html);
		this.$dom.toggleClass("none", count === 0);
	},
	setHasExceptions: function (hasExceptions) {
		this.$dom.toggleClass('exception', hasExceptions);
	},
};

$(function () {
	var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
		lineNumbers: true,
		 gutters: ['pill-gutter'],
	});
	
	var src = editor.getValue();
	var path = "script1";
	var instrumentedSrc = fondue.instrument(src, {
		tracer_name: "fiddleTracer",
		path: path,
	});
	eval(instrumentedSrc);
	
	var nodesById = {};
	var pillsByNodeId = {};
	var nodesHandle = fiddleTracer.trackNodes();
	fiddleTracer.newNodes(nodesHandle).filter(function (node) {
		return node.path === path;
	}).forEach(function (node) {
		nodesById[node.id] = node;
		if (node.type === "function") {
			pillsByNodeId[node.id] = new PillView(editor, node.start.line - 1);
		}
	});
	
	var hitsHandle = fiddleTracer.trackHits();
	var totalHitsByNodeId = {};
	setInterval(function () {
		var delta = fiddleTracer.hitCountDeltas(hitsHandle);
		for (var nodeId in delta) {
			var pill = pillsByNodeId[nodeId];
			if (delta.hasOwnProperty(nodeId) && pill) {
				totalHitsByNodeId[nodeId] || (totalHitsByNodeId[nodeId] = 0);
				totalHitsByNodeId[nodeId] += delta[nodeId];
				pill.setCount(totalHitsByNodeId[nodeId]);
			}
		}
	}, 100);
});
</script>

<textarea id="code">
$(document.body).on('mousemove', function () {
});

$(document.body).on('click', function () {
});

$(document.body).on('keypress', function () {
});

setInterval(function () {
	if (Math.random() &lt; 0.1) {
	} else {
	}
}, 500);
</textarea>
