<link rel="stylesheet/less" type="text/css" href="pill.less" />
<link rel="stylesheet/less" type="text/css" href="query_bar.less" />
<link rel="stylesheet/less" type="text/css" href="log.less" />
<script src="less.js?theseus=no" type="text/javascript"></script>
<script src="moment.min.js?theseus=no" type="text/javascript"></script>
<script src="fondue.browser.js?theseus=no" type="text/javascript"></script>
<script src="smokesignals.js" type="text/javascript"></script>
<script src="set.js" type="text/javascript"></script>
<script src="tree.js" type="text/javascript"></script>
<script src="log.js" type="text/javascript"></script>
<script src="pill.js" type="text/javascript"></script>
<script src="glyph.js" type="text/javascript"></script>
<script src="cycle.js" type="text/javascript"></script>
<script src="handle.js" type="text/javascript"></script>
<script src="query_bar.js" type="text/javascript"></script>

<style>
.CodeMirror {
	border: 1px solid black;
}
.CodeMirror-lines {
	line-height: 16px;
}
.CodeMirror .dead {
	background: rgba(0, 0, 0, 0.0825);
}
body, th, td {
	font-family: "Helvetica Neue", sans-serif;
	font-size: 14px;
}
</style>

<script type="text/javascript" src="jquery.js?theseus=no"></script>

<script src="codemirror-3.13/lib/codemirror.js?theseus=no"></script>
<link rel="stylesheet" href="codemirror-3.13/lib/codemirror.css">
<script src="codemirror-3.13/mode/javascript/javascript.js?theseus=no"></script>

<script>
var _colorCycle = new Cycle("#1f77b4 #ff7f0e #2ca02c #d62728 #9467bd #8c564b #e377c2 #7f7f7f #bcbd22 #17becf #000000".split(" "));
var _shapeCycle = new Cycle(["circle", "square"]);
var _glyphCycle = {
	next: function () {
		return new Glyph(_shapeCycle.next(), _colorCycle.next());
	},
};

$(function () {
	var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
		lineNumbers: true,
		gutters: ['pill-gutter'],
	});

	function convertPosToCodeMirror(pos) {
		return { line: pos.line - 1, ch: pos.column };
	}
	
	var src = editor.getValue();
	var path = "script1";
	var instrumentedSrc = fondue.instrument(src, {
		tracer_name: "fiddleTracer",
		path: path,
	});
	eval(instrumentedSrc);
	
	var logHandle = LogHandle(fiddleTracer, { ids: [], eventNames: [], exceptions: false, logs: false });
	var nodesHandle = NodesHandle(fiddleTracer);
	var hitsHandle = HitsHandle(fiddleTracer);
	var countConsoleLogsHandle = LogHandle(fiddleTracer, { logs: true }, false /* autoFetch */);
	var countExceptionsHandle = LogHandle(fiddleTracer, { exceptions: true }, false /* autoFetch */);
	var epochsHandle = EpochsHandle(fiddleTracer);

	var pillsByNodeId = {};
	var nodeGlyphs = {}; // nodeId -> glyph
	var deadNodeMarks = {}; // nodeId -> CodeMirror mark
	
	var logView = LogView(logHandle, nodesHandle);
	var queryBar = QueryBarView();

	queryBar.$dom.insertAfter(editor.getWrapperElement());
	logView.$dom.insertAfter(queryBar.$dom);

	function queryBarItemClicked(item) {
		item.toggle();

		var query = logHandle.lastQuery;
		if (item.isActive()) {
			item.addToQuery(query);
		} else {
			item.removeFromQuery(query);
		}
		logHandle.setQuery(query);
	}

	var logItem = QueryBarItem("console.log");
	var exceptionItem = QueryBarItem("exceptions");
	var nodeItems = {}; // nodeId -> item

	logItem.sortIndex = -1;
	logItem.$dom.addClass("logs");
	logItem.on("click", queryBarItemClicked);
	logItem.addToQuery = function (query) { query.logs = true };
	logItem.removeFromQuery = function (query) { query.logs = false };
	exceptionItem.sortIndex = -2;
	exceptionItem.$dom.addClass("exceptions");
	exceptionItem.on("click", queryBarItemClicked);
	exceptionItem.addToQuery = function (query) { query.exceptions = true };
	exceptionItem.removeFromQuery = function (query) { query.exceptions = false };

	countConsoleLogsHandle.on("pending", function (count) { logItem.setCount(count); queryBar.enableItem(logItem) });
	countExceptionsHandle.on("pending", function (count) { exceptionItem.setCount(count); queryBar.enableItem(exceptionItem) });
	epochsHandle.on("epochs", function () { console.log("epochs", arguments) });

	logHandle.on("queryChanged", function (newQuery) {
		logItem.setActive(newQuery.logs);
		exceptionItem.setActive(newQuery.exceptions);

		for (var nodeId in pillsByNodeId) {
			var pill = pillsByNodeId[nodeId];
			pill.setActive((newQuery.ids || []).indexOf(nodeId) !== -1);
		}

		if (newQuery.ids) {
			// remove items that aren't in the query any more
			setDifference(Object.keys(nodeItems), newQuery.ids).forEach(function (nodeId) {
				var item = nodeItems[nodeId];
				queryBar.disableItem(item);
				delete nodeItems[nodeId];
			});

			// add items that are now in the query
			setDifference(newQuery.ids, Object.keys(nodeItems)).forEach(function (nodeId) {
				var node = nodesHandle.nodeWithId(nodeId);
				var item = nodeItems[nodeId] = QueryBarItem(node.name);
				item.setActive(true);
				item.setCount(totalHitsByNodeId[nodeId] || 0);

				item.sortIndex = 0;
				item.addToQuery = function (query) { addToSet(query.ids, node.id) };
				item.removeFromQuery = function (query) { removeFromSet(query.ids, node.id) };
				item.on("click", queryBarItemClicked);

				queryBar.enableItem(item);
			});
		}
	});

	nodesHandle.on("nodes", function (nodes) {
		nodes.filter(function (node) { return node.path === path }).forEach(function (node) {
			nodeGlyphs[node.id] = _glyphCycle.next();

			if (node.type === "function") {
				var pill = pillsByNodeId[node.id] = new PillView(editor, node.start.line - 1, nodeGlyphs[node.id]);
				pill.on("click", function () {
					pill.toggle();

					var query = logHandle.lastQuery;
					if (pill.isActive()) {
						addToSet(query.ids, node.id);
					} else {
						removeFromSet(query.ids, node.id);
					}
					logHandle.setQuery(query);
				});
			}

			if (["function", "branch"].indexOf(node.type) !== -1) {
				if (!totalHitsByNodeId[node.id]) {
					deadNodeMarks[node.id] = editor.markText(convertPosToCodeMirror(node.start), convertPosToCodeMirror(node.end), { className: "dead" });
				}
			}
		});
	});
	
	var totalHitsByNodeId = {};
	hitsHandle.on("hits", function (delta) {
		for (var nodeId in delta) {
			totalHitsByNodeId[nodeId] || (totalHitsByNodeId[nodeId] = 0);
			totalHitsByNodeId[nodeId] += delta[nodeId];

			if (deadNodeMarks[nodeId]) {
				deadNodeMarks[nodeId].clear();
				delete deadNodeMarks[nodeId];
			}

			var pill = pillsByNodeId[nodeId];
			if (pill) {
				pill.setCount(totalHitsByNodeId[nodeId]);
			}

			var item = nodeItems[nodeId];
			if (item) {
				item.setCount(totalHitsByNodeId[nodeId]);
			}
		}
	});
});
</script>

<textarea id="code">
$(document.body).on('mousemove', function () { });
$(document.body).on('click', function () { });
$(document.body).on('keypress', function () { });

setInterval(function () {
	if (Math.random() &lt; 0.5) {
		console.log("hi")
	} else {
		console.lgo("hi")
	}
}, 2000);

function fib(n) {
	if (n &lt; 3) {
		return n;
	} else {
		return fib(n - 2) + fib(n - 1);
	}
}
fib(5);
</textarea>
