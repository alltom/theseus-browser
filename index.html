<link rel="stylesheet/less" type="text/css" href="pill.less" />
<script src="less.js?theseus=no" type="text/javascript"></script>
<script src="fondue.browser.js?theseus=no" type="text/javascript"></script>
<script src="pill.js" type="text/javascript"></script>
<script src="glyph.js" type="text/javascript"></script>
<script src="cycle.js" type="text/javascript"></script>
<script>
fondue = require("fondue");
</script>

<style>
.CodeMirror {
	border: 1px solid black;
}
</style>

<script type="text/javascript" src="jquery.js?theseus=no"></script>

<script src="codemirror-3.13/lib/codemirror.js?theseus=no"></script>
<link rel="stylesheet" href="codemirror-3.13/lib/codemirror.css">
<script src="codemirror-3.13/mode/javascript/javascript.js?theseus=no"></script>

<script>
var _colorCycle = new Cycle("#1f77b4 #ff7f0e #2ca02c #d62728 #9467bd #8c564b #e377c2 #7f7f7f #bcbd22 #17becf #000000".split(" "));
var _shapeCycle = new Cycle(["circle", "square"]);
var _glyphCycle = {
	next: function () {
		return new Glyph(_shapeCycle.next(), _colorCycle.next());
	},
};

 function LogHandle(tracer_, query) {
	 var handle = tracer_.trackLogs(query);
	 
	 return {
		 fetch: function () {
			 return tracer_.logDelta(handle, 10);
		 },
		 count: function () {
			 return tracer_.logCount(handle);
		 },
	 };
 }

$(function () {
	var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
		lineNumbers: true,
		 gutters: ['pill-gutter'],
	});
	
	var src = editor.getValue();
	var path = "script1";
	var instrumentedSrc = fondue.instrument(src, {
		tracer_name: "fiddleTracer",
		path: path,
	});
	eval(instrumentedSrc);
	
	var query = { ids: [], eventNames: [], exceptions: false, logs: false };
	var logHandle = new LogHandle(fiddleTracer, query); // !!!
	
	var countConsoleLogsHandle = new LogHandle(fiddleTracer, { ids: [], logs: true });
	var countExceptionsHandle = new LogHandle(fiddleTracer, { ids: [], exceptions: true });
	
	function queryChanged() {
		logHandle = fiddleTracer.trackLogs(query);
	}
	
	var nodesById = {};
	var pillsByNodeId = {};
	var nodesHandle = fiddleTracer.trackNodes();
	fiddleTracer.newNodes(nodesHandle).filter(function (node) {
		return node.path === path;
	}).forEach(function (node) {
		nodesById[node.id] = node;
		if (node.type === "function") {
			var pill = pillsByNodeId[node.id] = new PillView(editor, node.start.line - 1, _glyphCycle.next());
			pill.on("click", function () {
				pill.setActive(!pill.isActive);
			});
		}
	});
	
	var hitsHandle = fiddleTracer.trackHits();
	var totalHitsByNodeId = {};
	setInterval(function () {
		var delta = fiddleTracer.hitCountDeltas(hitsHandle);
		for (var nodeId in delta) {
			var pill = pillsByNodeId[nodeId];
			if (delta.hasOwnProperty(nodeId) && pill) {
				totalHitsByNodeId[nodeId] || (totalHitsByNodeId[nodeId] = 0);
				totalHitsByNodeId[nodeId] += delta[nodeId];
				pill.setCount(totalHitsByNodeId[nodeId]);
			}
		}
	}, 100);
});
</script>

<textarea id="code">
$(document.body).on('mousemove', function () {
});

$(document.body).on('click', function () {
});

$(document.body).on('keypress', function () {
});

setInterval(function () {
	if (Math.random() &lt; 0.1) {
	} else {
	}
}, 2000);
</textarea>
